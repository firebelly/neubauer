{% import 'macros/_controls' as controls %}
{% import 'macros/_cards' as cards %}

{% set entry = craft.entries.id(entryId).one() %}
{% set isSprig = sprig.isRequest %}
{# set default result count #}
{% set results = results ?? 0 %}
{# search result limit #}
{% set limit = limit ?? 10 %}
{# search filters #}
{% set filters = ['section','tags','search','sort'] %}
{% set trigger = sprig.trigger|split('_')[0] %}

{% if isSprig %}
{# Tags testing #}
{% if trigger == 'tags' %}
    {# {% set overlay = 'on' %} #}
{% endif %}
{% endif %}

{# sprig default vars #}
{% set overlay, section, tags, query, sort, date = overlay ?? 'off', section ?? 'all', tags ?? '', query ?? '', sort ?? 'asc', date ?? '' %}
{# reset current page if new filter is triggered #}
{% set page = isSprig and (trigger in filters) ? 1 : (page ?? 1) %}
{# sprig update url #}
{% do sprig.pushUrl('?' ~ {query: query, tags: tags, page: page}|url_encode) %}
{# sprig persistent state #}
{{ hiddenInput('overlay', overlay) }}
{{ hiddenInput('section', section) }}
{{ hiddenInput('tags', tags) }}
{{ hiddenInput('sort', sort) }}
{{ hiddenInput('date', date) }}
{{ hiddenInput('results', results) }}
{{ hiddenInput('page', page) }}

{# NOTE:
This is gross but the dialog.hide() method is not being triggered on close
due to the sprig component re-render so quickest/dirtiest solution is to inject this tiny
bit of javascript to assign proper overflow style on the html tag #}
{% if isSprig %}
<script>
    document.documentElement.style.overflowY = "{{ overlay == 'on' ? 'hidden' : '' }}";
</script>
{% endif %}

{# BEGIN RESULTING #}
{# Resource: https://craftcms.com/docs/3.x/relations.html#advanced-relationships #}
{# add relatedParams to params #}
{% set baseQuery = craft.entries() %}

{% if section != 'all' %}
    {% set baseQuery = baseQuery.section(section) %}
{% endif %}

{# handle tags #}
{% if tags %}
    {# get the tag(s) category object #}
    {% set tagArray = tags|split(',') %}
    {% set hasMultipleTags = (tagArray|length > 1) %}
    {% set category = hasMultipleTags ? [] : craft.categories().group('topics').slug(tags).one() %}

    {% if hasMultipleTags %}
    {% for tagSlug in tagArray %}
        {% set category = category|merge([craft.categories().group('topics').slug(tagSlug).one()]) %}
    {% endfor %}
    {% endif %}

    {% set baseQuery = baseQuery.relatedTo(category) %}
    
{% endif %}

{# handle filtering/sorting by date #}
{# source: https://craftcms.stackexchange.com/questions/36292/order-entries-by-multiple-matrix-date-field #}
{% if date %}
{# query matrix blocks that have a dateBlock #}
{# 
{% set matrixBlocksQuery = craft.matrixBlocks().field('dateBlock') %}
{% set uniqueDatesSorted = matrixBlocksQuery.all()|map(block => block.yearRange.itemFrom|date('Y'))|unique|sort %}

{% set allEntries = craft.entries
    .with('dateBlock')
    .dateBlock(':notempty:')
    .all()
%} 
#}
{% endif %}

{# define sorting #}
{% set byTitle = 'title ' ~ sort %}
{% set byTitleExcludeArticles = "(CASE WHEN `title` LIKE 'The %' THEN SUBSTRING(`title`, 5) WHEN `title` LIKE 'A %' THEN SUBSTRING(`title`, 3) ELSE `title` END)" ~ sort %}
{# get results #}
{# TODO: exclude index pages from query #}
{% set currentResults = (query ? baseQuery.search(query) : baseQuery).orderBy(byTitleExcludeArticles).limit(limit) %}
{# define pagination #}
{% set pageInfo = sprig.paginate(currentResults, page) %}
{% set results = currentResults|length %}
{% set resultsByPage = pageInfo.pageResults %}
{% set pageObj = {
    'page_info': pageInfo,
    'current_page': page
}%}
{# END RESULTING #}

{# Page Opener #}
<section class="pageOpener pageOpener--search">
    <h2 class="pageOpener-subtitle">Search</h2>
    {# result status #}
    <div class="pageOpener-container pageOpener-container--results">
        <h3 class="pageOpener-title">{{ results }}</span> Result{{ results != 1 ? 's' : ''}} for <br />"{{ query }}"</h3>
        <div class="pageOpener-desc">{{ entry.openerText }}</div>
    </div>
    {# search form #}
    {% set searchName,searchId,searchLabel,hasPlaceholder,isSprig = 'indexSearch','index','Enter keyword(s) here',true,true %}
    <div class="pageOpener-container pageOpener-container--control">
        {{ controls.controlSearch(searchName,searchId,searchLabel,hasPlaceholder,query) }}
    </div>
</section>

{# Search Filters #}
{% set excludeList = ['about-us'] %}
{% set sectionList = [{'displayText': 'All'}]|merge(primaryNav.navigationBlock.all()) %}

<section class="searchFilters">
    <h2 class="searchFilters-title">Filter the search</h2>
    <ul class="searchTabs">
    {% for tab in sectionList if tab.displayText|slugify not in excludeList %}
        {% set tabName = tab.displayText %} 
        {% set tabSlug = tabName == 'Research' ? 'projects' : tab.displayText|slugify %}
        {# NOTE: 
            Persist all active filters on open, close, and apply triggers;
            this is why we add the tags value to the section trigger below
        #} 
        <li class="searchTabs-item">
            <a 
                class="searchTabs-trigger{% if section == tabSlug %} _is-active{% endif %}" 
                id="section_tab_{{ tabSlug }}"
                href=""
                sprig
                s-val:section="{{ tabSlug }}"
                s-val:tags="{{ tags }}">
                <span class="searchTabs-label">{{ tabName }}</span>
            </a>
        </li>
    {% endfor %}
    </ul>

    {# dimensions control #}
    {% set filterList = [
        {
            'title': 'Sections',
            'sectionList': sectionList,
            'activeSection': section
        },
        {
            'title': 'Topics', 
            'tagList': craft.categories.group('topics'),
            'activeTags': tags
        }
    ] %}
    {% set filterName, filterLabel,resultsId = 'resultsFilter','Filter Results','#search_{{ searchId }}_results' %}
    {{ controls.controlDimensions(filterName,filterLabel,filterList,resultsId,overlay) }}

    {# sort control #}
    {% set sortName,sortLabel,sortOptions,activeSort = 'searchSort','Sort By Name (A-Z)',['asc','desc'], sort %}
    {{ controls.controlSort(sortName,sortLabel,sortOptions,activeSort) }}

    {# tag control #}
    {# {% set tagName,tagList,removeIconSlug = 'searchTags', craft.categories.group('topics'),'close' %}
    {% set activeTags = tags ?? null %}
    {{ controls.controlTagsFilter(tagName,tagList,activeTags,removeIconSlug) }} #}

</section>

{# RESULTS #}
<section class="searchResults" id="search_index_results">
    <h2 class="searchResults-title">Results:</h2>
    {% if results %}
    <div class="searchResults-content">
        {% for entry in resultsByPage %}
        {# <a href="{{ entry.url }}">{{ entry.title }}</a> #}
        {% set cardName,cardEntry = 'searchArticle', entry %}
        {{ cards.cardArticle(cardName,cardEntry) }}
        {% endfor %}
    </div>
    {% else %}
        No results
    {% endif %}
</section>

{# PAGINATION #}
{% if results %}
{% set pageName,pageRange,iconSize = 'searchPagination',5,20 %}
{{ controls.controlPagination(pageName,pageObj,pageRange,iconSize) }} 
{% endif %}

